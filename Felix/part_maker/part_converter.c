/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   part_converter.c                                   :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: fcoullou <fcoullou@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/04/21 20:02:10 by chatou            #+#    #+#             */
/*   Updated: 2025/04/22 17:47:54 by fcoullou         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "part_converter.h"

// Correspondance entre noms de notes et fréquences
int get_frequency(const char* note)
{
    if (strcmp(note, "C3") == 0) return C3;
    if (strcmp(note, "c3") == 0) return c3;
    if (strcmp(note, "D3") == 0) return D3;
    if (strcmp(note, "d3") == 0) return d3;
    if (strcmp(note, "E3") == 0) return E3;
    if (strcmp(note, "F3") == 0) return F3;
    if (strcmp(note, "f3") == 0) return f3;
    if (strcmp(note, "G3") == 0) return G3;
    if (strcmp(note, "g3") == 0) return g3;
    if (strcmp(note, "A3") == 0) return A3;
    if (strcmp(note, "a3") == 0) return a3;
    if (strcmp(note, "B3") == 0) return B3;
    if (strcmp(note, "C4") == 0) return C4;
    if (strcmp(note, "c4") == 0) return c4;
    if (strcmp(note, "D4") == 0) return D4;
    if (strcmp(note, "d4") == 0) return d4;
    if (strcmp(note, "E4") == 0) return E4;
    if (strcmp(note, "F4") == 0) return F4;
    if (strcmp(note, "f4") == 0) return f4;
    if (strcmp(note, "G4") == 0) return G4;
    if (strcmp(note, "g4") == 0) return g4;
    if (strcmp(note, "A4") == 0) return A4;
    if (strcmp(note, "a4") == 0) return a4;
    if (strcmp(note, "B4") == 0) return B4;
    if (strcmp(note, "C5") == 0) return C5;
    if (strcmp(note, "c5") == 0) return c5;
    if (strcmp(note, "D5") == 0) return D5;
    if (strcmp(note, "d5") == 0) return d5;
    if (strcmp(note, "E5") == 0) return E5;
    if (strcmp(note, "F5") == 0) return F5;
    if (strcmp(note, "f5") == 0) return f5;
    if (strcmp(note, "G5") == 0) return G5;
    if (strcmp(note, "g5") == 0) return g5;
    if (strcmp(note, "A5") == 0) return A5;
    if (strcmp(note, "a5") == 0) return a5;
    if (strcmp(note, "B5") == 0) return B5;
    if (strcmp(note, "C6") == 0) return C6;
    if (strcmp(note, "N0") == 0) return N0;
    
    return 0;
}

void parse_partition_from_string(const char **data, t_part *p)
{
    int i = 0;

    while (data[i] != NULL)
    {
        char note[3] = { data[i][0], data[i][1], '\0' };
        int freq = get_frequency(note);
        
        int j = 4;
        int t = 0;
        while (data[i][j] != '\0')
        {
            // fprintf(stderr, "data[%d][%d] = %c and t is : %d\n", i, j, data[i][j], t + 1);
            if (t >= TEMPS_MAX)
            {
                // fprintf(stderr, "Erreur : Dépassement de TEMPS_MAX with %d\n", t);
                break;
            }

            if (data[i][j] == '|')
            {
                j++;
                continue;
            }
            else if (data[i][j] == 'X')
            {
                int count = 0;
                while (p->notes[t].freqs[count] != 0 && count < 4)
                {
                    count++;
                }

                if (count < NOTES_MAX)
                {
                    p->notes[t].freqs[count] = freq;
                    p->notes[t].count++; // Incrémente le nombre de fréquences non nulles
                }
                else
                {
                    fprintf(stderr, "Erreur : Dépassement de NOTES_MAX au temps %d\n", t);
                }
            }
            t++;
            j++;
        }
        i++;            
    }
}

void write_partition_to_file(t_part *p)
{
    FILE *file = fopen("partition.h", "w");
    if (file == NULL)
    {
        perror("Erreur d'ouverture du fichier");
        return;
    }

    fprintf(file, "\n#pragma once\n\n#include \"head.h\"\n\nconst t_part tetris PROGMEM = {\n.notes = {   ");
    for (int i = 0; i < TEMPS_MAX; i++)
    {
        fprintf(file, "    {.freqs = {");
        for (int j = 0; j < 4; j++)
        {
            fprintf(file, "%d", p->notes[i].freqs[j]);
            if (j < 4 - 1)
                fprintf(file, ", ");
        }
        fprintf(file, "}, .count = %d},\n", p->notes[i].count);
    }
    fprintf(file, "    }\n};\n");
    fclose(file);

    printf("Fichier partition.c écrit avec succès.\n");
}

int main()
{
    const char *tetris_data[] = {
        "f2 |----|----|----|----|----|----|----|----|----|----|----|----|---X|X-XX|-X--|----|----|----|----|-X--|X-XX|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "G2 |----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|XXXX|XXXX|XXXX|XX--|----|----|-XX-|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "A2 |----|----|----|----|----|----|----|----|----|----|----|----|XXX-|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "a2 |----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|XXXX|XXXX|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "B2 |----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|XX--|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "C3 |----|--XX|XXXX|X---|----|----|----|----|----|----|---X|XX--|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "E3 |----|----|----|---X|XXX-|----|----|----|----|-XXX|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "f3 |----|----|----|----|----|XXXX|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "G3 |----|----|----|----|----|----|----|-XXX|XXXX|X---|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        "A3 |----|----|----|----|----|----|--XX|X---|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|",
        //    1    5    9   13   17   21   25   29   33   37   41   45   49   53   57   61   65   69   73   77   81   85   89   93   97  101  105  109  113  117  121  125  129
                NULL
		//   1    5    9    13   17   21   25   29   33   37   41   45   49   53   57   61   65
    };


        

    t_part p = {0}; // Initialisation de la partition


    // Partition lue depuis la chaîne de caractères
    parse_partition_from_string(tetris_data, &p);

    fprintf(stderr, "Partition parsed successfully.\n");
    write_partition_to_file(&p); // Appel de la fonction qui creer un fichier .c avec le tableau

}